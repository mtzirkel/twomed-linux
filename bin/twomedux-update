#!/bin/bash
# Pull latest Twomedux + dotfiles and re-apply configs
# Run anytime after pushing changes to either repo
set -e

OMAKUB_PATH="$HOME/.local/share/omakub"
export PATH="$OMAKUB_PATH/bin:$PATH"

echo "=== Twomedux Update ==="
echo ""

# --- Ensure GNOME session PATH ---
echo "[0/5] Setting session PATH..."
mkdir -p "$HOME/.config/environment.d"
cat > "$HOME/.config/environment.d/omakub.conf" <<EOF
PATH=\${HOME}/.local/share/omakub/bin:\${HOME}/.local/bin:\${HOME}/bin:\${PATH}
EOF

# --- Pull latest twomed-linux ---
echo "[1/5] Pulling twomed-linux..."
cd "$OMAKUB_PATH"
git fetch origin main
git reset --hard origin/main
cd - >/dev/null

# --- Pull latest dotfiles ---
echo "[2/5] Pulling dotfiles..."
if [ -d ~/.dotfiles ]; then
    git -C ~/.dotfiles pull
else
    git clone https://github.com/mtzirkel/dotfiles.git ~/.dotfiles
fi
bash ~/.dotfiles/install.sh

# --- Install Ghostty if missing ---
echo "[3/5] Checking Ghostty..."
if ! command -v ghostty &>/dev/null; then
    echo "  Installing Ghostty..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/mkasberg/ghostty-ubuntu/HEAD/install.sh)"
fi

# Ghostty config is handled by dotfiles/install.sh above

# --- Re-apply theme ---
echo "[4/5] Refreshing theme..."
CURRENT_THEME=$(cat ~/.config/omakub/current/theme.name 2>/dev/null || echo "Everforest")
omakub-theme-set "$CURRENT_THEME" 2>/dev/null || true

# --- Re-apply hotkeys ---
echo "[5/5] Refreshing keybinds..."
source "$OMAKUB_PATH/install/config/gnome/hotkeys.sh" 2>/dev/null || true

echo ""
echo "=== Twomedux updated! ==="
